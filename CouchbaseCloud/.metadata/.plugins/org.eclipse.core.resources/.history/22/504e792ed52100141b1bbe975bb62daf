


import os

import os.path
import subprocess

from couchbase import Couchbase

PATH = '/tmp/test.ini'

cb = Couchbase.connect (bucket = "default", host = "localhost")

while True:
    
    try:
        result = cb.get("DeploymentRequest").value
    except:
        continue
    if result['status'] == "DE":
        
        
        
        substr = "Can't establish SSH session"
        op = "Can't establish SSH session"
        print op.find(substr)
        while  op.find(substr) != -1 :
             p2 = subprocess.Popen(r'sudo -s python scripts/install.py -i /tmp/test.ini -p product=cb,version=3.0.0-966-rel,amazon=true',
                          cwd = r'/auth/testrunner', shell =True)

             output = p2.communicate()[0]
             print "Pisu"
             print output
             op = "{0}".format(output)
             print op
             p2.wait()
             
        result['status'] = 'IN'
        cb.set("DeploymentRequest",result)
        
        username = result['username']
        depname = result['depname']
        
        getVal = cb.get("user::{0}".format(username)).value
        
        
        for iter in getVal['deploy']:
            if iter['request']['depname'] == depname:
                ip = iter['bucket']['vm'][0] + ":8091"
                break
                
                
        cpu = int(result['cpus']) - 1 
        
        p4 = subprocess.Popen(r'sudo python testrunner.py -i /tmp/test.ini -t clitest.couchbase_clitest.CouchbaseCliTest.testAddRemoveNodes -p nodes_add={0},nodes_rem=0,skip_cleanup=True'.format(cpu),
                              cwd = r'/auth/testrunner', shell =True)
        p4.wait()
        
        
        cmd = """sudo ./couchbase-cli cluster-edit -c {0}
               --cluster-ramsize={1} 
               -u Administrator -p password""".format(ip,result['bucket_size'])
        p5 = subprocess.Popen(r'{0}'.cmd,cwd =r'/root/opt/couchbase/bin', shell =True)
        p5.wait()
        
        
        cmd = """sudo python testrunner.py -i /tmp/test.ini -t clitest.couchbase_clitest.CouchbaseCliTest.testBucketCreation
                -p bucket={0},bucket_type=couchbase,bucket_port=11222,bucket_replica={1},bucket_ramsize={2}""".format()